on: [push, pull_request]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: dotnet tool restore
      - run: dotnet csharpier check .
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: dotnet restore
      - run: dotnet build --no-restore --configuration Release WgConf.slnx
      - run: >-
          dotnet publish 
          --no-restore 
          --no-build 
          --configuration Release 
          --output artifacts/tests/WgConf.Tests
          tests/WgConf.Tests/WgConf.Tests.csproj
      - uses: actions/upload-artifact@v6
        with:
          path: artifacts/tests/WgConf.Tests
          name: build-WgConf.Tests
      - run: >-
          dotnet publish
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/tests/WgConf.Amnezia.Tests
          tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests.csproj
      - uses: actions/upload-artifact@v6
        with:
          path: artifacts/tests/WgConf.Amnezia.Tests
          name: build-WgConf.Amnezia.Tests
      - run: >-
          dotnet pack
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/packages
          src/WgConf/WgConf.csproj
      - uses: actions/upload-artifact@v6
        with:
          path: artifacts/packages/WgConf.*.*nupkg
          name: pkg-WgConf
      - run: >-
          dotnet pack
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/packages
          src/WgConf.Amnezia/WgConf.Amnezia.csproj
      - uses: actions/upload-artifact@v6
        with:
          path: artifacts/packages/WgConf.Amnezia.*.*nupkg
          name: pkg-WgConf.Amnezia
  test:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      actions: read
      contents: read
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        test-project:
          - WgConf.Tests
          - WgConf.Amnezia.Tests
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: build-${{ matrix.test-project }}
          path: tests/${{ matrix.test-project }}
      - run: chmod +x tests/${{ matrix.test-project }}/${{ matrix.test-project }}
      - run: >-
          ./tests/${{ matrix.test-project }}/${{ matrix.test-project }}
          --output Detailed
          --results-directory test_results/${{ matrix.test-project }}
          --report-ctrf
          --report-ctrf-filename report.json
          --report-xunit-html
          --report-xunit-html-filename report.html
      - uses: actions/upload-artifact@v6
        with:
          path: test_results/${{ matrix.test-project }}/report.json
          name: test-results-ctrf-${{ matrix.test-project }}
      - uses: actions/upload-artifact@v6
        with:
          path: test_results/${{ matrix.test-project }}/report.html
          name: test-results-html-${{ matrix.test-project }}
      - uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: test_results/${{ matrix.test-project }}/report.json
          artifact-name: test-results-ctrf-${{ matrix.test-project }}
          fetch-previous-results: true
          upload-artifact: false
          github-report: true
          summary: true
          summary-report: true
  coverage:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - run: >-
          dotnet tool install
          --global
          --verbosity normal
          dotnet-coverage
      - run: >-
          dotnet tool install
          --global
          --verbosity normal
          dotnet-reportgenerator-globaltool
      - uses: actions/download-artifact@v6
        with:
          path: tests/WgConf.Tests
          name: build-WgConf.Tests
      - uses: actions/download-artifact@v6
        with:
          path: tests/WgConf.Amnezia.Tests
          name: build-WgConf.Amnezia.Tests
      - run: chmod +x tests/WgConf.Tests/WgConf.Tests tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests
      - run: >-
          dotnet coverage collect
          --output coverage/WgConf.Tests.cobertura.xml
          --output-format cobertura
          --log-level Verbose
          "tests/WgConf.Tests/WgConf.Tests"
      - uses: actions/upload-artifact@v6
        with:
          path: coverage/WgConf.Tests.cobertura.xml
          name: coverage-cobertura-WgConf.Tests
      - run: >-
          dotnet coverage collect
          --output coverage/WgConf.Amnezia.Tests.cobertura.xml
          --output-format cobertura
          --log-level Verbose
          "tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests"
      - uses: actions/upload-artifact@v6
        with:
          path: coverage/WgConf.Amnezia.Tests.cobertura.xml
          name: coverage-cobertura-WgConf.Amnezia.Tests
      - name: Generate HTML coverage report
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/html-report
          -reporttypes:Html
      - uses: actions/upload-artifact@v6
        with:
          path: coverage/html-report
          name: coverage-html-combined
      - name: Generate JSON summary
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/json-summary
          -reporttypes:JsonSummary
      - name: Generate Markdown summary for job log
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/markdown-summary
          -reporttypes:MarkdownSummaryGithub
      - name: Append coverage summary to job summary
        run: |
          set -euo pipefail
          if [ -f coverage/markdown-summary/SummaryGithub.md ]; then
            SUMMARY_MD=coverage/markdown-summary/SummaryGithub.md
          elif [ -f coverage/markdown-summary/summarygithub.md ]; then
            SUMMARY_MD=coverage/markdown-summary/summarygithub.md
          elif [ -f coverage/markdown-summary/summary.md ]; then
            SUMMARY_MD=coverage/markdown-summary/summary.md
          else
            echo "Markdown summary not found in coverage/markdown-summary"
            ls coverage/markdown-summary
            exit 1
          fi

          {
            echo "## Combined Coverage Summary"
            cat "$SUMMARY_MD"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Enforce coverage thresholds
        run: |
          set -euo pipefail
          if [ -f coverage/json-summary/Summary.json ]; then
            SUMMARY_PATH=coverage/json-summary/Summary.json
          elif [ -f coverage/json-summary/summary.json ]; then
            SUMMARY_PATH=coverage/json-summary/summary.json
          else
            echo "Coverage summary JSON not found in coverage/json-summary"
            ls coverage/json-summary
            exit 1
          fi

          export SUMMARY_PATH
          python3 - <<'PY'
          import json, os, sys

          def coerce_num(val):
            try:
              return float(val)
            except (TypeError, ValueError):
              return None

          def pick(obj, *keys):
            for key in keys:
              if isinstance(obj, dict) and key in obj:
                num = coerce_num(obj[key])
                if num is not None:
                  return num
            return None

          path = os.environ["SUMMARY_PATH"]
          with open(path) as f:
            data = json.load(f)

          # ReportGenerator JsonSummary keeps totals in `summary`
          summary = data.get("summary") if isinstance(data, dict) else None
          if not summary and isinstance(data, dict):
            summary = data  # fallback: sometimes fields are at root

          line = branch = None
          line = pick(summary, "linecoverage", "lineCoverage", "line_coverage", "LineCoverage")
          branch = pick(summary, "branchcoverage", "branchCoverage", "branch_coverage", "BranchCoverage")

          if line is None and isinstance(summary, dict):
            covered = pick(summary, "coveredlines", "coveredLines")
            coverable = pick(summary, "coverablelines", "coverableLines")
            if covered is not None and coverable not in (None, 0):
              line = covered / coverable * 100

          if branch is None and isinstance(summary, dict):
            covered = pick(summary, "coveredbranches", "coveredBranches")
            total = pick(summary, "totalbranches", "totalBranches")
            if covered is not None and total is not None:
              branch = 100.0 if total == 0 else covered / total * 100

          if line is None or branch is None:
            sys.exit("Coverage metrics missing in summary JSON")

          print(f"Line coverage: {line:.2f}%")
          print(f"Branch coverage: {branch:.2f}%")

          failures = []
          if line < 95:
            failures.append(f"Line coverage {line:.2f}% is below required 95%")
          if branch < 80:
            failures.append(f"Branch coverage {branch:.2f}% is below required 80%")

          if failures:
            for msg in failures:
              print(msg)
            sys.exit(1)
          PY
