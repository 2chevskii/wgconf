name: "ðŸš€ Start Release"

on:
  push:
    tags:
      - "v*"

concurrency:
  group: release-start-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: "ðŸ”Ž Validate Tag"
    runs-on: ubuntu-latest
    outputs:
      prerelease: ${{ steps.tag_check.outputs.prerelease }}
    steps:
      - name: "ðŸ§¾ Checkout"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: "âœ… Validate tag and version"
        id: tag_check
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid tag: $TAG"
            exit 1
          fi

          VERSION=$(python3 - <<'PY'
          import xml.etree.ElementTree as ET
          root = ET.parse("Directory.Build.props").getroot()
          version = root.findtext(".//Version")
          if not version:
              raise SystemExit("Version not found in Directory.Build.props")
          print(version.strip())
          PY
          )

          if [[ "${TAG#v}" != "$VERSION" ]]; then
            echo "Tag ${TAG#v} does not match Version $VERSION"
            exit 1
          fi

          git fetch origin master --depth 1
          MASTER_SHA=$(git rev-parse origin/master)
          TAG_SHA=$(git rev-parse "$GITHUB_SHA")
          if [[ "$MASTER_SHA" != "$TAG_SHA" ]]; then
            echo "Tag must point to master tip"
            exit 1
          fi

          if [[ "$TAG" == *"-"* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

  format:
    name: "ðŸŽ¨ Format Check"
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: "ðŸ§¾ Checkout"
        uses: actions/checkout@v6
      - name: "ðŸ“¦ Cache NuGet"
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', 'Directory.Packages.props', 'Directory.Build.props', 'global.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-
      - name: "ðŸ› ï¸ Restore Tools"
        run: dotnet tool restore
      - name: "ðŸŽ¯ CSharpier Check"
        run: dotnet csharpier check .

  build:
    name: "ðŸ—ï¸ Build & Package"
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: "ðŸ§¾ Checkout"
        uses: actions/checkout@v6
      - name: "ðŸ“¦ Cache NuGet"
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', 'Directory.Packages.props', 'Directory.Build.props', 'global.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-
      - name: "ðŸ“¦ Restore Dependencies"
        run: dotnet restore
      - name: "ðŸ”¨ Build Solution"
        run: dotnet build --no-restore --configuration Release WgConf.slnx
      - name: "ðŸ§ª Publish WgConf.Tests"
        run: >-
          dotnet publish
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/tests/WgConf.Tests
          tests/WgConf.Tests/WgConf.Tests.csproj
      - name: "ðŸ“¤ Upload WgConf.Tests"
        uses: actions/upload-artifact@v6
        with:
          path: artifacts/tests/WgConf.Tests
          name: build-WgConf.Tests
      - name: "ðŸ§ª Publish WgConf.Amnezia.Tests"
        run: >-
          dotnet publish
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/tests/WgConf.Amnezia.Tests
          tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests.csproj
      - name: "ðŸ“¤ Upload WgConf.Amnezia.Tests"
        uses: actions/upload-artifact@v6
        with:
          path: artifacts/tests/WgConf.Amnezia.Tests
          name: build-WgConf.Amnezia.Tests
      - name: "ðŸ“¦ Pack WgConf"
        run: >-
          dotnet pack
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/packages
          src/WgConf/WgConf.csproj
      - name: "ðŸ“¦ Pack WgConf.Amnezia"
        run: >-
          dotnet pack
          --no-restore
          --no-build
          --configuration Release
          --output artifacts/packages
          src/WgConf.Amnezia/WgConf.Amnezia.csproj
      - name: "ðŸ“¤ Upload Release Packages"
        uses: actions/upload-artifact@v6
        with:
          name: release-packages
          path: |
            artifacts/packages/*.nupkg
            artifacts/packages/*.snupkg

  test:
    name: "ðŸ§ª Test Matrix"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      actions: read
      contents: read
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        test-project:
          - WgConf.Tests
          - WgConf.Amnezia.Tests
    steps:
      - name: "ðŸ“¥ Download Build Artifact"
        uses: actions/download-artifact@v7
        with:
          name: build-${{ matrix.test-project }}
          path: tests/${{ matrix.test-project }}
      - name: "ðŸ” Ensure Executable"
        run: chmod +x tests/${{ matrix.test-project }}/${{ matrix.test-project }}
      - name: "ðŸƒ Run Tests"
        run: >-
          ./tests/${{ matrix.test-project }}/${{ matrix.test-project }}
          --output Detailed
          --results-directory test_results/${{ matrix.test-project }}
          --report-ctrf
          --report-ctrf-filename report.json
          --report-xunit-html
          --report-xunit-html-filename report.html
      - name: "ðŸ“¤ Upload CTRF Report"
        uses: actions/upload-artifact@v6
        with:
          path: test_results/${{ matrix.test-project }}/report.json
          name: test-results-ctrf-${{ matrix.test-project }}
      - name: "ðŸ“¤ Upload HTML Report"
        uses: actions/upload-artifact@v6
        with:
          path: test_results/${{ matrix.test-project }}/report.html
          name: test-results-html-${{ matrix.test-project }}
      - name: "ðŸ§¾ Publish Test Summary"
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: test_results/${{ matrix.test-project }}/report.json
          artifact-name: test-results-ctrf-${{ matrix.test-project }}
          fetch-previous-results: true
          upload-artifact: false
          github-report: true
          summary: true
          summary-report: true

  coverage:
    name: "ðŸ“Š Coverage"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: "ðŸ§¾ Checkout"
        uses: actions/checkout@v6
      - name: "ðŸ“¦ Cache NuGet"
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', 'Directory.Packages.props', 'Directory.Build.props', 'global.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-
      - name: "ðŸ› ï¸ Install dotnet-coverage"
        run: >-
          dotnet tool install
          --global
          --verbosity normal
          dotnet-coverage
      - name: "ðŸ› ï¸ Install ReportGenerator"
        run: >-
          dotnet tool install
          --global
          --verbosity normal
          dotnet-reportgenerator-globaltool
      - name: "ðŸ“¥ Download WgConf.Tests"
        uses: actions/download-artifact@v7
        with:
          path: tests/WgConf.Tests
          name: build-WgConf.Tests
      - name: "ðŸ“¥ Download WgConf.Amnezia.Tests"
        uses: actions/download-artifact@v7
        with:
          path: tests/WgConf.Amnezia.Tests
          name: build-WgConf.Amnezia.Tests
      - name: "ðŸ” Ensure Executables"
        run: chmod +x tests/WgConf.Tests/WgConf.Tests tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests
      - name: "ðŸ§ª Collect WgConf.Tests Coverage"
        run: >-
          dotnet coverage collect
          --output coverage/WgConf.Tests.cobertura.xml
          --output-format cobertura
          --log-level Verbose
          "tests/WgConf.Tests/WgConf.Tests"
      - name: "ðŸ“¤ Upload WgConf.Tests Coverage"
        uses: actions/upload-artifact@v6
        with:
          path: coverage/WgConf.Tests.cobertura.xml
          name: coverage-cobertura-WgConf.Tests
      - name: "ðŸ§ª Collect WgConf.Amnezia.Tests Coverage"
        run: >-
          dotnet coverage collect
          --output coverage/WgConf.Amnezia.Tests.cobertura.xml
          --output-format cobertura
          --log-level Verbose
          "tests/WgConf.Amnezia.Tests/WgConf.Amnezia.Tests"
      - name: "ðŸ“¤ Upload WgConf.Amnezia.Tests Coverage"
        uses: actions/upload-artifact@v6
        with:
          path: coverage/WgConf.Amnezia.Tests.cobertura.xml
          name: coverage-cobertura-WgConf.Amnezia.Tests
      - name: "ðŸ“ˆ Generate HTML Coverage Report"
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/html-report
          -reporttypes:Html
      - name: "ðŸ“¤ Upload HTML Coverage Report"
        uses: actions/upload-artifact@v6
        with:
          path: coverage/html-report
          name: coverage-html-combined
      - name: "ðŸ§¾ Generate JSON Summary"
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/json-summary
          -reporttypes:JsonSummary
      - name: "ðŸ§¾ Generate Markdown Summary"
        run: >-
          reportgenerator
          "-reports:coverage/WgConf.Tests.cobertura.xml;coverage/WgConf.Amnezia.Tests.cobertura.xml"
          -targetdir:coverage/markdown-summary
          -reporttypes:MarkdownSummaryGithub
      - name: "ðŸ§· Append Summary to Job"
        run: |
          set -euo pipefail
          if [ -f coverage/markdown-summary/SummaryGithub.md ]; then
            SUMMARY_MD=coverage/markdown-summary/SummaryGithub.md
          elif [ -f coverage/markdown-summary/summarygithub.md ]; then
            SUMMARY_MD=coverage/markdown-summary/summarygithub.md
          elif [ -f coverage/markdown-summary/summary.md ]; then
            SUMMARY_MD=coverage/markdown-summary/summary.md
          else
            echo "Markdown summary not found in coverage/markdown-summary"
            ls coverage/markdown-summary
            exit 1
          fi

          {
            echo "## Combined Coverage Summary"
            cat "$SUMMARY_MD"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: "âœ… Enforce Coverage Thresholds"
        run: |
          set -euo pipefail
          if [ -f coverage/json-summary/Summary.json ]; then
            SUMMARY_PATH=coverage/json-summary/Summary.json
          elif [ -f coverage/json-summary/summary.json ]; then
            SUMMARY_PATH=coverage/json-summary/summary.json
          else
            echo "Coverage summary JSON not found in coverage/json-summary"
            ls coverage/json-summary
            exit 1
          fi

          export SUMMARY_PATH
          python3 - <<'PY'
          import json, os, sys

          def coerce_num(val):
            try:
              return float(val)
            except (TypeError, ValueError):
              return None

          def pick(obj, *keys):
            for key in keys:
              if isinstance(obj, dict) and key in obj:
                num = coerce_num(obj[key])
                if num is not None:
                  return num
            return None

          path = os.environ["SUMMARY_PATH"]
          with open(path) as f:
            data = json.load(f)

          # ReportGenerator JsonSummary keeps totals in `summary`
          summary = data.get("summary") if isinstance(data, dict) else None
          if not summary and isinstance(data, dict):
            summary = data  # fallback: sometimes fields are at root

          line = branch = None
          line = pick(summary, "linecoverage", "lineCoverage", "line_coverage", "LineCoverage")
          branch = pick(summary, "branchcoverage", "branchCoverage", "branch_coverage", "BranchCoverage")

          if line is None and isinstance(summary, dict):
            covered = pick(summary, "coveredlines", "coveredLines")
            coverable = pick(summary, "coverablelines", "coverableLines")
            if covered is not None and coverable not in (None, 0):
              line = covered / coverable * 100

          if branch is None and isinstance(summary, dict):
            covered = pick(summary, "coveredbranches", "coveredBranches")
            total = pick(summary, "totalbranches", "totalBranches")
            if covered is not None and total is not None:
              branch = 100.0 if total == 0 else covered / total * 100

          if line is None or branch is None:
            sys.exit("Coverage metrics missing in summary JSON")

          print(f"Line coverage: {line:.2f}%")
          print(f"Branch coverage: {branch:.2f}%")

          failures = []
          if line < 95:
            failures.append(f"Line coverage {line:.2f}% is below required 95%")
          if branch < 80:
            failures.append(f"Branch coverage {branch:.2f}% is below required 80%")

          if failures:
            for msg in failures:
              print(msg)
            sys.exit(1)
          PY

  release:
    name: "ðŸ“£ Draft GitHub Release"
    runs-on: ubuntu-latest
    needs:
      - validate
      - format
      - build
      - test
      - coverage
    permissions:
      contents: write
    steps:
      - name: "ðŸ“¥ Download Release Packages"
        uses: actions/download-artifact@v7
        with:
          name: release-packages
          path: artifacts/packages
      - name: "ðŸ“ Create Draft Release"
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: ${{ needs.validate.outputs.prerelease == 'true' }}
          generate_release_notes: false
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: |
            artifacts/packages/*.nupkg
            artifacts/packages/*.snupkg
